Final code is in the luke branch.
